---
title: "Snapshot Day AIS Monitoring Summary"
format:
  html:
    pagetitle: "Snapshot Day AIS Monitoring Summary - Water Action Volunteers"
---

```{r setup}
#| include: false

library(tidyverse)
library(sf)
library(leaflet)
library(leaflet.extras)
library(janitor)
library(gt)
library(DT)

knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))

load("snapshot-day-summary.RData")

plt_theme <- theme(
  axis.text.x = element_text(face = "bold", size = 10),
  panel.background = element_blank(),
  legend.position = "none"
)

dt <- function(.data) {
  datatable(
    .data,
    extensions = "Buttons",
    options = list(
      lengthMenu = c(5, 10, 25),
      dom = "Bfrtipl",
      buttons = c("copy", "csv", "excel")
    )
  )
}

```

Snapshot Day is a volunteer AIS (Aquatic Invasive Species) monitoring program. Visit [Water Action Volunteers](https://wateractionvolunteers.org/){target="_blank"} for more information.

## Interactive map

*This map shows all locations that were monitored at least once for AIS on a Snapshot Day. Individual fieldwork events are shown as blue markers when no AIS was found, or orange markers when at least one AIS species was reported present. Click on a marker to get more information about an AIS fieldwork event.*

```{r fig.height=9}
ais_pts_labelled <- ais_pts %>%
  mutate(label = paste0(
      "<b>Station ", station_id, ": ", station_name, "</b><br>",
      "Fieldwork date: ", date, ", Waterbody monitored: ", waterbody_name, "<br>",
      "Species found: ", str_wrap_html(species_found), "<br>",
      "Fieldwork comment: ", str_wrap_html(fieldwork_comment)
    ) %>% lapply(shiny::HTML)
  )

county_shapes <- wi_counties %>%
  left_join(county_ais_summary) %>%
  mutate(popup = create_popups(.)) %>%
  mutate(label = paste0(
      "<b>", county, " County</b> - ",
      if_else(
        is.na(species),
        "Not monitored",
        paste0(species, " species found<br>Species: ", str_wrap_html(species_found))
      )
    ) %>% lapply(shiny::HTML)
  )

watershed_shapes <- watersheds %>%
  left_join(watershed_ais_summary) %>%
  mutate(popup = create_popups(.)) %>%
  mutate(label = paste0(
      "<b>", dnr_watershed_name, " Watershed (", dnr_watershed_code, ")</b> - ",
      if_else(
        is.na(species),
        "Not monitored",
        paste0(species, " species found<br>Species: ", str_wrap_html(species_found))
      )
    ) %>% lapply(shiny::HTML)
  )

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    data = county_shapes,
    label = ~label, popup = ~popup,
    color = "grey", weight = .5, opacity = .5,
    fillColor = ~colorNumeric("viridis", species)(species), fillOpacity = .1,
    group = "Counties"
  ) %>%
  addPolygons(
    data = watershed_shapes,
    label = ~label,popup = ~popup,
    color = "grey", weight = .5, opacity = .5,
    fillColor = ~colorNumeric("viridis", species)(species), fillOpacity = .1,
    group = "Watersheds"
  ) %>%
  addCircleMarkers(
    data = ais_pts_labelled %>% filter(n_species == 0),
    label = ~label, popup = ~popup,
    radius = 4,
    color = "black", weight = 1, opacity = 1,
    fillColor = "skyblue", fillOpacity = 1
  ) %>%
    addCircleMarkers(
    data = ais_pts_labelled %>% filter(n_species > 0),
    label = ~label, popup = ~popup,
    radius = 4,
    color = "black", weight = 1, opacity = 1,
    fillColor = "orange", fillOpacity = 1
  ) %>%
  addLayersControl(overlayGroups = c("Counties", "Watersheds")) %>%
  addFullscreenControl(pseudoFullscreen = T)
```

## Static map

*Stations monitored for AIS at any time between 2014 and present are shown below.*

```{r fig.height=7}
county_counts <- ais_pts %>%
  st_set_geometry(NULL) %>%
  count(county)

ggplot() +
  geom_sf(data = wi_counties) +
  geom_sf(
    data = wi_counties %>%
      left_join(county_counts) %>%
      drop_na(),
    aes(fill = n), alpha = .5) +
  geom_sf(data = wi, fill = NA, lwd = .75) +
  geom_sf_text(data = wi_counties, aes(label = county), angle = 15, size = 2, alpha = .5) +
  geom_sf(data = filter(ais_pts, n_species == 0), fill = "skyblue", shape = 24, size = 2.5) +
  geom_sf(data = filter(ais_pts, n_species > 0), fill = "orange", shape = 24, size = 3) +
  scale_fill_viridis_c(na.value = "grey90") +
  labs(fill = "Stations\nin county\n") +
  theme_void()
```

### AIS monitoring locations by year

```{r fig.height=7}
pts <- fieldwork_events %>%
  distinct(station_id, latitude, longitude, year, county) %>%
  to_sf()

county_counts <- wi_counties %>%
  left_join({
    pts %>% st_drop_geometry() %>% count(year, county)
  }) %>% drop_na(year)

ggplot() +
  geom_sf(data = wi_counties) +
  geom_sf(data = county_counts, aes(fill = n), alpha = .5) +
  geom_sf(data = wi, fill = NA, lwd = .5) +
  geom_sf(data = pts, shape = 24, fill = "white", size = 1) +
  scale_fill_viridis_c(na.value = "grey90") +
  facet_wrap(~ year) +
  labs(fill = "Stations per county") +
  guides(fill = guide_colorsteps(frame.colour = "black", show.limits = T)) +
  theme_void() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = .5, margin = margin(t = 4, b = 4)),
    strip.text = element_text(face = "bold", size = 12, margin = margin(t = 8, b = 2))
  )
```

## Participation summary

### Number of volunteers

*Volunteer counts are determined by unique full names tagged to a fieldwork event by a data submitter group id.*

```{r}
ais_groups %>%
  mutate(year = as.character(year)) %>%
  summarize(n = n_distinct2(name), .by = year) %>%
  ggplot(aes(x = year, y = n, fill = n, label = n)) +
  geom_col(color = "black") +
  geom_text(vjust = -1) +
  scale_y_continuous(expand = expansion(c(.01, .1))) +
  scale_fill_viridis_c() +
  labs(x = NULL, y = "Number of volunteers") +
  plt_theme
  
```

### Number of fieldwork events

*Fieldwork events represent a complete data submission to the SWIMS system, identified by a fieldwork sequence number (fsn).*

```{r}
fieldwork_events %>%
  mutate(year = as.character(year)) %>%
  summarize(n = n_distinct2(fsn), .by = year) %>%
  ggplot(aes(x = year, y = n, fill = n, label = n)) +
  geom_col(color = "black") +
  geom_text(vjust = -1) +
  scale_y_continuous(expand = expansion(c(.01, .1))) +
  scale_fill_viridis_c() +
  labs(x = NULL, y = "Number of fieldwork events") +
  plt_theme
  
```

### Number of stations monitored

*SWIMS stations may be point stations or river/stream segments identified by a station id.*

```{r}
fieldwork_events %>%
  mutate(year = as.character(year)) %>%
  summarize(n = n_distinct2(station_id), .by = year) %>%
  ggplot(aes(x = year, y = n, fill = n, label = n)) +
  geom_col(color = "black") +
  geom_text(vjust = -1) +
  scale_y_continuous(expand = expansion(c(.01, .1))) +
  scale_fill_viridis_c() +
  labs(x = NULL, y = "Number of stations") +
  plt_theme
  
```

### Number of distinct waterbodies monitored

*Waterbodies are differentiated by a unique WBIC.*

```{r}
fieldwork_events %>%
  mutate(year = as.character(year)) %>%
  summarize(n = n_distinct2(wbic), .by = year) %>%
  ggplot(aes(x = year, y = n, fill = n, label = n)) +
  geom_col(color = "black") +
  geom_text(vjust = -1) +
  scale_y_continuous(expand = expansion(c(.01, .1))) +
  scale_fill_viridis_c() +
  labs(x = NULL, y = "Number of waterbodies") +
  plt_theme
  
```

### Number of watersheds monitored

*Watersheds are differentiated by a unique DNR Watershed Code.*

```{r}
fieldwork_events %>%
  mutate(year = as.character(year)) %>%
  summarize(n = n_distinct2(dnr_watershed_code), .by = year) %>%
  ggplot(aes(x = year, y = n, fill = n, label = n)) +
  geom_col(color = "black") +
  geom_text(vjust = -1) +
  scale_y_continuous(expand = expansion(c(.01, .1))) +
  scale_fill_viridis_c() +
  labs(x = NULL, y = "Number of watersheds") +
  plt_theme
  
```

### Number of counties monitored

```{r}
fieldwork_events %>%
  mutate(year = as.character(year)) %>%
  summarize(n = n_distinct2(county), .by = year) %>%
  ggplot(aes(x = as.character(year), y = n)) +
  geom_col(aes(fill = n), color = "black") +
  geom_text(aes(label = n), vjust = -.5) +
  scale_y_continuous(expand = expansion(c(0, .1))) +
  scale_fill_viridis_c() +
  labs(y = "Counties monitored", x = NULL) +
  plt_theme
```

## Fieldwork summary

### What species are commonly looked for or not looked for?

*These questions are coded in SWIMS as DNR parameters 91157 - 91172. These questions specifically ask if a data submitter looked for one of these species. They may answer YES or NO, but they may also leave the question blank (marked as 'No answer').*

```{r fig.height=6}
ais_looked_for <- ais_results %>%
  filter(parameter_code %in% 91157:91172) %>%
  mutate(
    parameter_name = parameter_name %>%
      str_replace("\\?", "") %>%
      str_replace("Did you look for ", "") %>%
      str_to_title()) %>%
  mutate(total = n_distinct2(fsn)) %>%
  mutate(result = tolower(result)) %>%
  summarize(n = n(), .by = c(parameter_code, parameter_name, result, total)) %>%
  pivot_wider(names_from = result, values_from = n, values_fill = 0) %>%
  mutate(na = total - yes - no) %>%
  mutate(across(c(yes, no, na), ~ .x / total)) %>%
  arrange(desc(yes)) %>%
  mutate(parameter_name = fct_inorder(parameter_name))

ais_looked_for %>%
  pivot_longer(cols = c(yes, no, na)) %>%
  mutate(
    name = name %>%
      case_match(
        "yes" ~ "Yes",
        "no" ~ "No",
        "na" ~ "No answer"
      ) %>%
      factor(levels = c("Yes", "No", "No answer"))
  ) %>%
  mutate(label = scales::percent(value, 1)) %>%
  ggplot(aes(x = value, y = parameter_name, fill = name)) +
  geom_col(color = "white", lwd = .25, position = position_stack(reverse = T)) +
  geom_text(
    aes(label = label),
    position = position_stack(vjust = .5, reverse = T)) +
  scale_x_continuous(
    labels = scales::percent,
    expand = expansion(c(0, .05))) +
  scale_fill_manual(values = c("#00ba38", "#f8766d", "#619cff")) +
  labs(
    y = NULL,
    x = str_glue("Percent of fieldwork (n = {ais_looked_for$total[1]})"),
    fill = "Did you look for this AIS?") +
  theme(
    legend.position = "top",
    panel.background = element_blank())
```

### Species looked for by year

```{r fig.height=6}
ais_looked_for <- ais_results %>%
  filter(parameter_code %in% 91157:91172) %>%
  mutate(
    parameter_name = parameter_name %>%
      str_replace("\\?", "") %>%
      str_replace("Did you look for ", "") %>%
      str_to_title()) %>%
  mutate(result = tolower(result)) %>%
  mutate(total = n_distinct2(fsn), .by = year) %>%
  summarize(n = n(), .by = c(year, parameter_code, parameter_name, result, total)) %>%
  pivot_wider(names_from = result, values_from = n, values_fill = 0) %>%
  mutate(na = total - yes - no) %>%
  mutate(across(c(yes, no, na), ~ .x / total)) %>%
  arrange(desc(yes)) %>%
  mutate(parameter_name = fct_inorder(parameter_name)) %>%
  mutate(year = as.character(year))

ais_looked_for %>%
  pivot_longer(cols = c(yes, no, na)) %>%
  mutate(
    answer = name %>%
      case_match("yes" ~ "Yes", "no" ~ "No", "na" ~ "No answer") %>%
      factor(levels = c("Yes", "No", "No answer"))) %>%
  mutate(label = scales::percent(value, 1)) %>%
  ggplot(aes(x = year, y = value, fill = answer)) +
  geom_col(color = "white", lwd = .1, width = 1) +
  scale_y_continuous(
    labels = scales::percent,
    expand = expansion(c(0, .05))) +
  scale_fill_manual(values = c("#00ba38", "#f8766d", "#619cff")) +
  facet_wrap(~parameter_name) +
  labs(
    x = "Year",
    y = str_glue("Percent of fieldwork"),
    fill = "Did you look for this AIS?") +
  theme(
    legend.position = "top",
    panel.background = element_blank())
```

### What other write-in species do people look for?

*This question is coded in SWIMS as 91173. Species mentioned only once or fieldwork comments entered in this field are ignored. Volunteers often input species names with different capitalizations or listed several in a sentence, here an automated process was used to try to clean up and tally mentions of different species.*

```{r fig.height=4}
ais_looked_for_other <- ais_results %>%
  filter(parameter_code == 91173) %>%
  pull(result) %>%
  na.omit() %>%
  paste(collapse = ", ") %>%
  str_replace_all(coll(";"), ",") %>%
  str_replace_all(coll("."), "") %>%
  str_replace_all(coll(" and ", ignore_case = T), ", ") %>%
  str_split(",", simplify = T) %>%
  str_trim() %>%
  sort() %>%
  str_to_title() %>%
  as_tibble() %>%
  filter(nchar(value) > 0) %>%
  count(value) %>%
  arrange(desc(n))

ais_looked_for_other %>%
  filter(n > 1) %>%
  mutate(value = fct_rev(fct_inorder(value))) %>%
  ggplot(aes(x = n, y = value, fill = n)) +
  geom_col(color = "white", width = 1) +
  geom_text(aes(label = n), hjust = -.25) +
  scale_fill_viridis_c() +
  scale_x_continuous(
    breaks = scales::breaks_pretty(),
    expand = expansion(c(0, .1))) +
  labs(x = "Number of times mentioned", y = NULL) +
  theme(
    legend.position = "none",
    panel.background = element_blank())
```

## How often are AIS found when looked for?

### Frequency of any AIS presence by year

*During a fieldwork data submission in SWIMS, volunteers may indicate that they found one or more invasive species during their survey. In the table below, counts are for counties, watersheds (defined by DNR Watershed Code), waterbodies (defined by WBIC; note that this may be incomplete as some fieldwork does not have a WBIC associated with it), and stations (defined by SWIMS Station ID). Values indicate the number of each category where at least one AIS was found in a fieldwork event out of the total number of fieldwork events.*

```{r}
sumfn <- function(.data, group, ...) {
  summarize(
    .data,
    counties = n_distinct2(county),
    watersheds = n_distinct2(dnr_watershed_code),
    waterbodies = n_distinct2(wbic),
    stations = n_distinct2(station_id),
    ...
  ) %>% mutate(group = group)
}

totals <- bind_rows(
  ais_finds %>% sumfn(1),
  fieldwork_events %>% sumfn(2),
) %>% mutate(year = "(All)")

annuals <- bind_rows(
  ais_finds %>% sumfn(1, .by = year),
  fieldwork_events %>% sumfn(2, .by = year)
) %>%
  arrange(group, desc(year)) %>%
  mutate(year = as.character(year))

bind_rows(totals, annuals) %>%
  summarize(across(
    c(counties, watersheds, waterbodies, stations),
    ~ sprintf("%i / %i (%.0f%%)", .x[1], .x[2], .x[1] / .x[2] * 100)
  ), .by = year) %>%
  clean_names(case = "sentence") %>%
  gt()
```

### Number of stations where each AIS was found by year

*Stations are defined by SWIMS Station ID.*

```{r}
totals <- ais_finds %>% count(result, name = "Any")

ais_finds %>%
  count(year, result) %>%
  pivot_wider(names_from = year, values_from = n, values_fill = 0) %>%
  left_join(totals) %>%
  rename(Species = result) %>%
  arrange(desc(Any)) %>%
  gt() %>%
  data_color(method = "numeric", palette = "viridis")
```

### Frequency of any AIS presence by county

#### Quick-reference table

```{r}
sumfn <- function(.data, group, ...) {
  summarize(
    .data,
    years = n_distinct2(year),
    watersheds = n_distinct2(dnr_watershed_code),
    waterbodies = n_distinct2(wbic),
    stations = n_distinct2(station_id),
    ...
  ) %>% mutate(group = group)
}

totals <- bind_rows(
  ais_finds %>% sumfn(1),
  fieldwork_events %>% sumfn(2),
) %>% mutate(county = "(All)")

annuals <- bind_rows(
  ais_finds %>% sumfn(1, .by = county),
  fieldwork_events %>% sumfn(2, .by = county)
) %>%
  complete(
    county, group,
    fill = list(years = 0, watersheds = 0, waterbodies = 0, stations = 0)
  ) %>%
  arrange(group, desc(stations))

bind_rows(totals, annuals) %>%
  summarize(across(
    c(years, watersheds, waterbodies, stations),
    ~ sprintf("%i / %i (%.0f%%)", .x[1], .x[2], .x[1] / .x[2] * 100)
  ), .by = county) %>%
  clean_names(case = "sentence") %>%
  gt()
```

#### Detailed table

```{r}
sumfn <- function(.data, group, ...) {
  summarize(
    .data,
    years = n_distinct2(year),
    watersheds = n_distinct2(dnr_watershed_code),
    waterbodies = n_distinct2(wbic),
    stations = n_distinct2(station_id),
    ...
  ) %>% mutate(group = group)
}

totals <- bind_rows(
  ais_finds %>% sumfn("found"),
  fieldwork_events %>% sumfn("looked_for"),
) %>% mutate(county = "(All)")

annuals <- bind_rows(
  ais_finds %>% sumfn("found", .by = county),
  fieldwork_events %>% sumfn("looked_for", .by = county)
)

bind_rows(totals, annuals) %>%
  pivot_longer(c(years, watersheds, waterbodies, stations)) %>%
  pivot_wider(names_from = group) %>%
  mutate(freq = found / looked_for) %>%
  pivot_longer(c(found, looked_for, freq), names_to = "stat") %>%
  mutate(name = paste(name, stat, sep = "_")) %>%
  select(-stat) %>%
  pivot_wider() %>%
  mutate(across(ends_with("_freq"), ~sprintf("%.0f%%", .x * 100))) %>%
  arrange(county) %>%
  clean_names(case = "sentence") %>%
  dt()
```

## New detections of AIS

```{r}
new_ais_plt <- function(df, name) {
  df <- df %>%
    rename(all_of(c(value = name))) %>%
    mutate(sp_total = sum(value), .by = result) %>%
    arrange(sp_total) %>%
    mutate(result = fct_inorder(result)) %>%
    mutate(id_type = factor(id_type, levels = c("new", "existing"))) %>%
    arrange(result, desc(id_type)) %>%
    mutate(label = paste0(if_else(id_type == "new", "+", ""), value))
  
  df %>%
    ggplot(aes(x = value, y = result)) +
    geom_col(aes(fill = id_type), position = "stack", color = "black", lwd = .1) +
    { if (n_distinct(df$year) == 1) geom_text(aes(label = label), position = "stack", hjust = -.2, size = 3) } +
    scale_x_continuous(expand = expansion(c(0, .1))) +
    facet_grid(~year) +
    labs(
      title = paste("Number of", name, "where AIS have been reported"),
      y = NULL, x = NULL,
      fill = "Identification type"
    ) +
    theme(
      legend.position = "bottom",
      panel.background = element_blank(),
      panel.grid = element_blank(),
      panel.grid.major.y = element_line(color = "grey90"),
      axis.ticks.x = element_blank(),
      axis.text.x = element_blank()
    )
}
```

### New detections by site

*Unique sites are identified by their SWIMS Station ID.*

```{r}
new_ais_by_site %>%
  new_ais_plt("sites")
```

```{r}
new_ais_by_site %>%
  filter(year == max(year)) %>%
  new_ais_plt("sites")
```



### New detections by waterbody

*Unique watersheds are identified by their DNR Watershed Code.*

```{r}
new_ais_by_waterbody %>%
  new_ais_plt("waterbodies")
```

```{r}
new_ais_by_waterbody %>%
  filter(year == max(year)) %>%
  new_ais_plt("waterbodies")
```

### New detections by watershed

*Unique watersheds are identified by their DNR Watershed Code.*

```{r}
new_ais_by_watershed %>%
  new_ais_plt("watersheds")
```

```{r}
new_ais_by_watershed %>%
  filter(year == max(year)) %>%
  new_ais_plt("watersheds")
```

### New detections by county

```{r}
new_ais_by_county %>%
  new_ais_plt("counties")
```

```{r}
new_ais_by_county %>%
  filter(year == max(year)) %>%
  new_ais_plt("counties")
```

## Which AIS are commonly found?

### AIS finds by county

```{r}
ais_finds %>%
  summarize(
    species = n_distinct(result),
    species_names = to_summary_list(result),
    .by = county
  ) %>%
  arrange(desc(species)) %>%
  clean_names(case = "title") %>%
  dt()
```

### AIS finds by watershed

```{r}
ais_finds %>%
  summarize(
    species = n_distinct(result),
    species_names = to_summary_list(result),
    .by = c(dnr_watershed_name, county)
  ) %>%
  arrange(desc(species)) %>%
  clean_names(case = "title") %>%
  dt()
```

### AIS finds by waterbody

```{r}
ais_finds %>%
  drop_na(wbic) %>%
  summarize(
    species = n_distinct(result),
    species_names = to_summary_list(result),
    .by = c(wbic, waterbody_name, county)
  ) %>%
  arrange(desc(species)) %>%
  clean_names(case = "title") %>%
  dt()
```

### AIS finds by site

```{r}
ais_finds %>%
  summarize(
    species = n_distinct(result),
    species_names = to_summary_list(result),
    .by = c(station_id, station_name, county)
  ) %>%
  arrange(desc(species)) %>%
  clean_names(case = "title") %>%
  dt()
```

## SWIMS parameters associated with AIS fieldwork

*When volunteers submit data to SWIMS each field has an internal parameter code as well as a description (which is shown to the submitter). In the table below, the frequency indicates how many times the parameter was included in the AIS dataset.*

```{r}
dnr_parameters %>%
  set_names(c("Code", "Description", "Frequency")) %>%
  gt()
```

::: {style="margin-top: 4em; border-top: 1px solid grey; color: grey; font-size: small"}
*AIS Snapshot Day summary developed by Ben Bradford (UW-Madison Entomology) and Emily Heald (Rivers Educator, UW-Extension NRI). Data courtesy Wisconsin DNR.*
:::
